<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <title></title>

    <!--SCRIPTS-->

    <script src="../Scripts/autoComplte.js"></script>
    <script src="../Scripts/ajaxCalls.js"></script>
    <script src="../Scripts/dateFunctions.js"></script>


    <script type="text/javascript" src="https://code.jquery.com/jquery-3.3.1.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>





    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <!-- Latest compiled JavaScript -->
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>


    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link href="Style.css" rel="stylesheet" />


    <!--//data table-->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/responsive/2.2.3/css/responsive.dataTables.min.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js"></script>
    <script src="../Scripts/ajaxCalls.js"></script>
    <script src="../Scripts/dateFunctions.js"></script>
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>


    <!--CSS-->
    <link href="Style.css" rel="stylesheet" />

    <script>
        currentTrips = []
        airportList = [];
        airportArr = [];
        selectedTrips=[]
        itemsInCart = 0;
        $(document).ready(function () {
            updateCartNumber()
            loadAirports();
            $("#flightForm").submit(loadTrips)
        });

        
        function loadAirports() { // Load the airports list from API

            url = "https://api.skypicker.com/locations?type=dump&locale=en-US&location_types=airport&limit=4000&active_only=true&sort=name";

            $.get(url).done(successCB);
            $.get(url).fail(errFunc);
        }


        function cart() {

            str = ""
            trips = JSON.parse(localStorage.getItem('trips'));
            document.getElementById('ph2').innerHTML = "";
            str += "<div class='container-fluid'>";
            for (var i = 0; i < trips.length; i++) {

                str += '<div class="row">';

                str += '<div class="col-sm-3">'
                str += " <div class='card' style='width:18rem;'>";
                if (currentTrips[trips[i]]['images'][0] == undefined)
                    str += "<img src='https://dilavr.com.ua/image/catalog/empty-img.png' class='card-img-top' alt='...' style='width:100%;height:215px;'> ";
                else {

                    str += "<img onerror=defaultImage(this) src='" + currentTrips[trips[i]]['images'][0]['sizes']['medium']['url'] + "' class='card-img-top' alt='...' style='width:100%;height:215px;'>";
                }

                str += "<div class='card-body'>";
                str += "<h5 class='card-title'>" + currentTrips[trips[i]]['name'] + "</h5>";
                str += " <p class='card-text' style='width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;'>" + currentTrips[trips[i]]['intro'] + "</p>"
                str += " <h6 class='card-title'><b>Score:</b> " + currentTrips[trips[i]]['score'] + "</p>"
                str += " <h6 class='card-title'><b>Distance:</b> " + currentTrips[trips[i]]['distance'] + " Meters</p>"
                str += " <h6 class='card-title'><b>Opening Hours:</b><br>\n " + getOpeningHours(currentTrips[trips[i]]) + "</p>"
                str += " <a id=" + i + " onclick='addToCart(this.id)' class='btn btn-primary'>Add</a>"


                str += "</div></div></div>";

                str += '</div>';

               
            }

             document.getElementById('ph2').innerHTML = str;
        }


        function successCB(data) {
            airportList = data;
            ajaxCall("GET", "../api/Airport", "", SCGetAirportTable, errFunc);


        }

        function updateCartNumber() {
            document.getElementById("cartCounter").innerHTML = "Items In Cart: " + itemsInCart

        }

        function addToCart(tripId) {
            itemsInCart++;
            updateCartNumber()
            selectedTrips.push(tripId)
            localStorage.setItem('trips', JSON.stringify(selectedTrips))
        }

        function finishBuildDeal()
        {

        }

        function defaultImage(img) {
            img.src = 'https://dilavr.com.ua/image/catalog/empty-img.png';
             }


        function getOpeningHours(place) {
            let str = ""
            if (place['opening_hours'] == null)
                return "No Opening Hours Data";
            if (place['opening_hours']['open_24_7'] == true)
                return "Open 24/7";
            for (day in place['opening_hours']['days']) {

                if (Array.isArray(place['opening_hours']['days'][day]) && place['opening_hours']['days'][day].length)
                    for (var i = 0; i < place['opening_hours']['days'][day].length; i++) {
                        if (place['opening_hours']['days'][day][i]['start'] && place['opening_hours']['days'][day][i]['end']) {
                            str += "<p>" + day + " From: " + place['opening_hours']['days'][day][i]['start']['hour'] + ":" + place['opening_hours']['days'][day][i]['start']['minute']
                            str += " To: " + place['opening_hours']['days'][day][i]['end']['hour'] + ":" + place['opening_hours']['days'][day][i]['end']['minute'] + "</p>"
                        }
                        else {
                            str += "<p>" + day + ": Close" + "</p>"
                            break;
                        }
                    }
                else str+="<p>"+day+": Close"+"</p>"
                  
            }
            return str;
        }

        function errFunc(err) {
            swal("Error: " + err);
        }


        function SCGetAirportTable(data) {


            if (data != null) {
                flag = 1;
            }

            var options = "";
            for (i in airportList['locations']) {
                options += '<option  value="' + airportList['locations'][i]['id'] + '" >' + airportList['locations'][i]['city']['name'] + '</option>';
                airportArr[airportList['locations'][i]['id']] = [airportList['locations'][i]['location']['lon'], airportList['locations'][i]['location']['lat'], airportList['locations'][i]['city']['name']];
            }


            document.getElementById('airportFrom').innerHTML = options;



        }

        function a() {
            console.log('long' + airportArr[$(".airportFrom").val()][0] + 'lat:+' + airportArr[$(".airportFrom").val()][1]);
        }

        function loadTrips() {
            currentTrips=[]
            let url = "https://www.triposo.com/api/20200405/poi.json?account=GHJA9MHT&token=hirq8t8e96qfgwt9p6vxx8i0nfhhicjj&tag_labels=!hotels&distance=<" + $("#distance").val() + "&count=100&fields=id,name,score,intro,tag_labels,images,opening_hours,snippet&order_by=distance&tag_labels=!lunch&tag_labels=architectural_style|do|nightlife&tag_labels=!shopping&annotate=distance:" + airportArr[$(".airportFrom").val()][1] + "," + airportArr[$(".airportFrom").val()][0]
            console.log(url);

            $.get(url).done(successAPICB);
            $.get(url).fail(errFunc);
            return false;
        }
        
        function successAPICB(data) {
            str = ""
            currentTrips = data['results']
            document.getElementById('ph').innerHTML = "";
            str += "<div class='container-fluid'>";
            for (var i = 0; i < data['results'].length; i++) {
                if (i % 4 == 0) {
                    str += '<div class="row">';
                } 
                str+='<div class="col-sm-3">'
                str += " <div class='card' style='width:18rem;'>";
                 if (data['results'][i]['images'][0]== undefined)
                str += "<img src='https://dilavr.com.ua/image/catalog/empty-img.png' class='card-img-top' alt='...' style='width:100%;height:215px;'> ";
                else {
                    
                     str += "<img onerror=defaultImage(this) src='" + data['results'][i]['images'][0]['sizes']['medium']['url'] + "' class='card-img-top' alt='...' style='width:100%;height:215px;'>";
                }
               
                str += "<div class='card-body'>";
                str += "<h5 class='card-title'>"+data['results'][i]['name']+"</h5>";
                str += " <p class='card-text' style='width:250px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;'>" + data['results'][i]['snippet']+"</p>"
                str += " <h6 class='card-title'><b>Score:</b> " + data['results'][i]['score'] + "</p>"
                str += " <h6 class='card-title'><b>Distance:</b> " + data['results'][i]['distance'] + " Meters</p>"
                str += " <h6 class='card-title'><b>Opening Hours:</b><br>\n " + getOpeningHours(data['results'][i]) + "</p>"
                str += " <a id=" + i + " onclick='addToCart(this.id)' class='btn btn-primary'>Add</a>"
                

                str += "</div></div></div>";
                       if ((i+1) % 4 == 0) {
                    str += '</div>';
                } 
            }

            str += '</div>';
            document.getElementById('ph').innerHTML = str;
            
        }


        function errFunc(err) {
            console.log("Error: " + err);
        }
    </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col header">
                <img src="../images/—Pngtree—blue and red airplane vector_4235031.png" />
                <h1>Flight.com</h1>
            </div>
        </div>

        <nav class="navbar navbar-expand-lg navbar-light bg-light">

            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav" id="menu">
                    <a class="navbar-brand" href="./">Home</a>
                    <a id="ordersTab" class="navbar-brand" href="#">Orders</a>
                    <a id="discountsTab" class="navbar-brand" href="#">Discount</a>
                </ul>
            </div>
        </nav>

        
        <form autocomplete="off" action="" id="flightForm">
            <table>
              
                <tr>
                    <td><b>Choose Airport:</b></td>
                    <td>  <input name="airPort" list="airportFrom" class="airportFrom formelement" required />  <datalist id="airportFrom"></datalist></td>
                    <td><b>Distance:</b></td>
                    <td><input type="number" id="distance" required /></td>
                    <td><p id="cartCounter">Items In Cart:</p></td>
                    <td> <input type="button" value="Cart" onclick="cart()" /></td>
<td>  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
            Launch demo modal
        </button></td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <button class="btn btn-primary" type="submit">Find Trips!</button>

                        </td>

                    </tr>

                </table>

            </form>

            <div id="ph"></div>
            <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Cart</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div id="ph2"> </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary">Save changes</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
    </html>
