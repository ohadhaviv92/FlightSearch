<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="css.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <!-- Popper JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script src="../Scripts/autoComplte.js"></script>
    <script src="../Scripts/ajaxCalls.js"></script>
    
    <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

    <script>
        countryCodes = [];
        Myflightsarr = [];
        data2 = {};
        flag = 0;
        dataArr = {} //Store the current search arr
        $(document).ready(function () {
            $("#srcBTN").submit(searchFlights);
            //$("#srcBTN").click(searchFlights)
            $("#MyFlights").click(MyFlights)
            
            $("#fromDate").min = new Date().toISOString().split("T")[0];
            url = "https://api.skypicker.com/locations?type=dump&locale=en-US&location_types=airport&limit=4000&active_only=true&sort=name";
            $('#GetAirports').click(loadAirports);
            $('#GetAirLines').click(loadAirLines);

            var now = new Date(),
                // minimum date the user can choose, in this case now and in the future
                minDate = now.toISOString().substring(0, 10);

            $('#fromDate').prop('min', minDate);//Cant fly backwards

            $('#toDate').prop('min', minDate); //Cant fly backwards

            
        });

        function loadAirLines() {

            url = "https://api.skypicker.com/airlines";
            $.get(url).done(successLoadAirLines);
            $.get(url).fail(errorCB);



        }
        function successLoadAirLines(data) {
             for (i in data) {
                 if (data[i]['type'] == "airline") {
                airline = { // Note that the name of the fields must be identical to the names of the properties of the object in the server
                    AirlineCode: data[i]['id'],
                    AirlineName: data[i]['name'],
                };
                     ajaxCall("POST", "../api/Airline", JSON.stringify(airline), postSuccess, errorCB);
              }

            }
        }

        function successCB(data) {
            data2 = data;
            ajaxCall("GET", "../api/Airport", "", SCGetAirportTable, errMyFlights);
        
        }

        function SCGetAirportTable(data) {
            if (data != "" && data != null) {
                flag = 1;
            }
                var options = "";
            for (i in data2['locations']) {
                 options += '<option value="'+data2['locations'][i]['id']+'" >'+data2['locations'][i]['name']+'</option>';
                if (flag == 0) {
                    airport = { // Note that the name of the fields must be identical to the names of the properties of the object in the server
                        AirportCode: data2['locations'][i]['code'],
                        Airportname: data2['locations'][i]['name'],
                        Longitude: data2['locations'][i]['location']['lon'],
                        Latitudes: data2['locations'][i]['location']['lat'],
                        City: data2['locations'][i]['city']['name'],
                        Coutry: data2['locations'][i]['city']['country']['name']

                    };
                    ajaxCall("POST", "../api/Airport", JSON.stringify(airport), postSuccess, errorCB)
                 }
            }
            document.getElementById('airportFrom').innerHTML = options;
            document.getElementById('airportTo').innerHTML = options;
        }

        function loadAirports() { // Load the airports to the DB, Only Once!
            $.get(url).done(successCB);
            $.get(url).fail(errorCB);
        }



        $(document).on("click", ".addBTN", function () {
            counter = 0;
            console.log(dataArr['data'][$(this).attr('id')])
            let from = dataArr['data'][$(this).attr('id')]['cityFrom']
            let to = dataArr['data'][$(this).attr('id')]['cityTo']
            let price = dataArr['data'][$(this).attr('id')]['price']
            let depTime = dataArr['data'][$(this).attr('id')]['dTime']
            let aTime = dataArr['data'][$(this).attr('id')]['aTime']
            let airline = dataArr['data'][$(this).attr('id')]['route'][0]['airline']
            legs = [dataArr['data'][$(this).attr('id')]['route'].length]
            for (var i = 0; i < dataArr['data'][$(this).attr('id')]['route'].length; i++) {
                counter++;
            }


            flight = { FlightPath1: dataArr['data'][$(this).attr('id')]['id'], AirportFrom1: dataArr['data'][$(this).attr('id')]['flyFrom'], AirportTo1: dataArr['data'][$(this).attr('id')]['flyTo'], DepTime1: dataArr['data'][$(this).attr('id')]['dTime'], ArriveTime1: dataArr['data'][$(this).attr('id')]['aTime'], Duration1: dataArr['data'][$(this).attr('id')]['duration']['total'], price: parseFloat(dataArr['data'][$(this).attr('id')]['price']), LegsNumber1:counter}
            ajaxCall('POST', "../api/flight", JSON.stringify(flight), postSuccess, posterr)
            for (i = 0; i < counter; i++) {
                legs.push(dataArr['data'][$(this).attr('id')]['route'][i]['cityTo']) ///////need to add the legs here!!!!!!!!!!!!!!!!!!!!
                l = {
                    id: dataArr['data'][$(this).attr('id')]['route'][i]['id'], fullpathid: dataArr['data'][$(this).attr('id')]['id'], legnumber: (i + 1), flight_no: dataArr['data'][$(this).attr('id')]['route'][i]['flight_no'], fromairport: dataArr['data'][$(this).attr('id')]['route'][i]['flyFrom'], toairport: dataArr['data'][$(this).attr('id')]['route'][i]['flyTo'], airlinecode: dataArr['data'][$(this).attr('id')]['route'][i]['airline'], DepTime1: dataArr['data'][$(this).attr('id')]['route'][i]['dTime'], ArriveTime1: dataArr['data'][$(this).attr('id')]['route'][i]['aTime'], Duration1: "fix this"
                }
                legs.push(l) ///////need to add the legs here!!!!!!!!!!!!!!!!!!!!
                ajaxCall('POST', "../api/Leg", JSON.stringify(l), postSuccess, posterr)
            }
        });


        function MyFlights() {
            ajaxCall("GET", "../api/flight", "", successMyFlights, errMyFlights)
        }

        function successMyFlights(data) {
            i = 1
            str = "<table class='table table-striped'><thead><tr><th scope='col'>#</th><th scope='col'>From</th><th scope='col'>To</th><th scope='col'>Departure time</th><th scope='col'>Arrival time</th><th scope='col'>Stops</th><th scope='col'>Airline name</th><th scope='col'>Price</th></tr></thead><tbody>"
            for (flight in data) {
                let depTime = new Date(0);
                let arrTime = new Date(0);
                depTime.setUTCSeconds(data[flight]['DepTime'])
                arrTime.setUTCSeconds(data[flight]['ArriveTime'])
                str += "<tr><th scope='row'>" + i + "</th>"
                str += "<td>" + data[flight]['From'] + "</td>"
                str += "<td>" + data[flight]['To'] + "</td>"
                str += "<td>" + dateToFulldate(depTime) + "</td>"
                str += "<td>" + dateToFulldate(arrTime) + "</td>"
                if (data[flight]['Stops'].length > 1) {
                    str += "<td>"
                    for (j = 0; j < data[flight]['Stops'].length - 1; j++) {
                        str += data[flight]['Stops'][j] + ", "
                    }
                    str += "(" + j + " Connections)</td>"
                }
                else {
                    str += "<td> No Stops</td>"
                }
                str += "<td>" + data[flight]['AirlineName'] + "</td>"
                str += "<td>" + data[flight]['Price'] + " Euro</td>"
                i++
            }
            str += "</tbody></table>"
            document.getElementById('ph').innerHTML = str;
        }
        function errMyFlights(err) {
            console.log(1);
        }

        function searchFlights() {
            let from = $(".airportFrom").val()
            let to = $(".airportTo").val()
            let dep = $("#fromDate").val()
            let arrive = $("#toDate").val()
            let url = "https://api.skypicker.com/flights?flyFrom=" + from + "&to=" + to + "&dateFrom=" + fixDate(dep) + "&dateTo=" + fixDate(arrive) + "&partner=picky"
            let api = ajaxCall("GET", url, "", successAPICB, errorAPICB)
            return false;
        }
        function successAPICB(data) {
            i = 0;
            console.log(data);
            dataArr = data
            str = "<table class='table table-striped'><thead><tr><th scope='col'>#</th><th scope='col'>From</th><th scope='col'>To</th><th scope='col'>Departure time</th><th scope='col'>Arrival time</th><th scope='col'>Stops</th><th scope='col'>Airline name</th><th scope='col'>Price</th><th scope='col'>Store Flight?</th></tr></thead><tbody>"
            for (flight in data['data']) {
                let depTime = new Date(0);
                let arrTime = new Date(0);
                depTime.setUTCSeconds(data['data'][flight]['dTime'])
                arrTime.setUTCSeconds(data['data'][flight]['aTime'])
                str += "<tr><th scope='row'>" + (i + 1) + "</th>"
                str += "<td>" + data['data'][flight]['cityFrom'] + ", " + data['data'][flight]['countryFrom']['name'] + "</td>"
                str += "<td>" + data['data'][flight]['cityTo'] + ", " + data['data'][flight]['countryTo']['name'] + "</td>"
                str += "<td>" + dateToFulldate(depTime) + "</td>"
                str += "<td>" + dateToFulldate(arrTime) + "</td>"
                if (data['data'][flight]['route'].length > 1) {
                    str += "<td>"
                    connectionsArr = []
                    getConnections(data['data'][flight]['route'])
                    for (var j = 0; j < connectionsArr.length - 1; j++) {
                        str += connectionsArr[j] + ", "
                    }
                    str += "(" + j + " Connections)</td>"
                }
                else {
                    str += "<td> No Stops</td>"
                }
                str += "<td>" + data['data'][flight]['route'][0]['airline'] + "</td>"
                str += "<td>" + data['data'][flight]['price'] + " Euro</td>"
                str += "<td><button type='button' class='btn btn-primary addBTN' id=" + (i) + ">Add</button></td></tr>"
                i++

            }
            str += "</tbody></table>"
            document.getElementById('ph').innerHTML = str;
            swal("Added Successfuly!", "Great Job", "success");
            
        }

        function getConnections(connectionsList) {
            for (var j = 0; j < connectionsList.length; j++) {
                connectionsArr.push(connectionsList[j]['cityTo'])
            }

        }

        function postSuccess() {
            console.log('Flight added')
            
        }
        function posterr(err) {
            console.log(err)
        }

        function dateToFulldate(d) {
            let min = d.getMinutes()
            if (min < 10)
                return d.getDate() + "/" + (d.getMonth() + 1) + "/" + d.getFullYear() + "<br>" + (d.getHours()) + ":" + (d.getMinutes() + "0");
            else
                return d.getDate() + "/" + (d.getMonth() + 1) + "/" + d.getFullYear() + "<br>" + (d.getHours()) + ":" + (d.getMinutes())
        }
        function errorAPICB(err) {
            console.log(err);
        }

        function fixDate(date) {
            dateArr = date.split("-");
            return dateArr[2] + "/" + dateArr[1] + "/" + dateArr[0];
        }




        function errorCB(err) {
            console.log(err);
        }



    </script>
</head>
<body>
    <div class="container-fluid">
        <img src="../images/banner.jpg" class="img-fluid" alt="Responsive image">
        <form autocomplete="off" action="" id="srcBTN">
            <table>
                <tr><td><b>Flight from:</b></td></tr>
                <tr><td>  <input name="airPort" list="airportFrom" class="airportFrom" required/>  <datalist id="airportFrom"></datalist></td><td><input required="required" type="date" id="fromDate" /></td></tr>
                <tr><td><b>To:</b></td></tr>
                <tr ><td><input name="airPort" list="airportTo" class="airportTo" required/>  <datalist id="airportTo"></datalist></td><td><input required="required" type="date" id="toDate" /></td></tr>
                <tr>
                    <td><button class="btn btn-primary" type="submit" >Find Flights!</button></td> <!--Type should be submit!-->
                </tr>
                <tr>
                
                </tr>
            </table>

        </form>
           <button id="MyFlights" type="button" class="btn btn-primary">My Flights</button>
            <button id="GetAirports" type="button" class="btn btn-primary">Get Airports</button>
            <button id="GetAirLines" type="button" class="btn btn-primary">Get AirLines</button>

        <div id="ph"></div>
    </div>
</body>
</html>

